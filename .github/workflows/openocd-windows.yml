# Manually started actino to build OpenOCD for Windows and upload to an artifact

name: OpenOCD Build All Windows
on: [workflow_dispatch]
jobs:
  build:
    runs-on: windows-latest
    defaults:
      run:
        shell: msys2 {0}
    strategy:
      matrix:
        include:
          - { sys: mingw64, env: x86_64 }
          - { sys: mingw32, env: i686 }
    steps:
    - uses: msys2/setup-msys2@v2
      with:
        msystem: ${{matrix.sys}}
        install: development make libtool pkg-config autoconf automake texinfo mingw-w64-${{matrix.env}}-libusb mingw-w64-${{matrix.env}}-hidapi git mingw-w64-${{matrix.env}}-toolchain patch
    - name: Build ${{matrix.env}}
      run: |
        git clone https://github.com/raspberrypi/openocd.git
        pushd openocd
        git checkout rp2040
        echo Fixing GCC 12 warning
        echo ZGlmZiAtLWdpdCBhL3NyYy9oZWxwZXIvY29uZmlndXJhdGlvbi5jIGIvc3JjL2hlbHBlci9jb25m\
        aWd1cmF0aW9uLmMKaW5kZXggMTE0YWQyYzZjLi45ZjhiNGM3ZjQgMTAwNjQ0Ci0tLSBhL3NyYy9o\
        ZWxwZXIvY29uZmlndXJhdGlvbi5jCisrKyBiL3NyYy9oZWxwZXIvY29uZmlndXJhdGlvbi5jCkBA\
        IC0xNDYsNiArMTQ2LDkgQEAgaW50IHBhcnNlX2NvbmZpZ19maWxlKHN0cnVjdCBjb21tYW5kX2Nv\
        bnRleHQgKmNtZF9jdHgpCiAKIGNoYXIgKmdldF9ob21lX2Rpcihjb25zdCBjaGFyICphcHBlbmRf\
        cGF0aCkKIHsKKyNpZmRlZiBfV0lOMzIKKwljaGFyIGhvbWVwYXRoW01BWF9QQVRIXTsKKyNlbmRp\
        ZgogCWNoYXIgKmhvbWUgPSBnZXRlbnYoIkhPTUUiKTsKIAogCWlmIChob21lID09IE5VTEwpIHsK\
        QEAgLTE1NSw3ICsxNTgsNiBAQCBjaGFyICpnZXRfaG9tZV9kaXIoY29uc3QgY2hhciAqYXBwZW5k\
        X3BhdGgpCiAKIAkJaWYgKGhvbWUgPT0gTlVMTCkgewogCi0JCQljaGFyIGhvbWVwYXRoW01BWF9Q\
        QVRIXTsKIAkJCWNoYXIgKmRyaXZlID0gZ2V0ZW52KCJIT01FRFJJVkUiKTsKIAkJCWNoYXIgKnBh\
        dGggPSBnZXRlbnYoIkhPTUVQQVRIIik7CiAJCQlpZiAoZHJpdmUgJiYgcGF0aCkgewo= | base64 -d -i > bug.patch
        patch -p1 < bug.patch
        bash bootstrap
        ./configure --prefix=/tmp/openocd --enable-picoprobe --enable-cmsis-dap-v2 --enable-cmsis-dap \
                    --disable-dummy --disable-rshim --disable-ftdi  --disable-stlink --disable-ti-icdi \
                    --disable-ulink --disable-usb-blaster-2 --disable-ft232r --disable-vsllink \
                    --disable-xds110  --disable-osbdm --disable-opendous --disable-aice --disable-usbprog \
                    --disable-rlink --disable-armjtagew --disable-nulink --disable-kitprog \
                    --disable-usb-blaster --disable-presto --disable-openjtag --disable-jlink \
                    --disable-parport --disable-parport-ppdev --disable-parport-giveio --disable-jtag_vpi \
                    --disable-jtag_dpi --disable-amtjtagaccel --disable-zy1000-master --disable-zy1000 \
                    --disable-ioutil --disable-bcm2835gpio --disable-imx_gpio --disable-ep93xx \
                    --disable-at91rm9200 --disable-gw16012 --disable-oocd_trace --disable-buspirate \
                    --disable-sysfsgpio --disable-xlnx-pcie-xvc --disable-minidriver-dummy \
                    --disable-remote-bitbang
        make
        make install
        echo Copying needed DLLs and packaging as tarball
        cp /mingw*/bin/libhidapi*.dll /tmp/openocd/bin/.
        cp /mingw*/bin/libusb*.dll /tmp/openocd/bin/.
        popd
        strip /tmp/openocd/bin/openocd.exe
        tar cvf openocd.${{matrix.env}}.tar -C /tmp openocd
    - name: Upload Artifact
      uses: actions/upload-artifact@v3
      with:
        name: openocd.${{matrix.env}}.tar
        path: openocd.${{matrix.env}}.tar
